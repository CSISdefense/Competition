---
title: "Competition_Regression"
author: "Greg Sanders"
date: "Sunday, March 15, 2015"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

```{r hiddensetup, echo = FALSE}
require(ggplot2)
require(stringr)
require(plyr)
require(Hmisc)
options(error=recover)
setwd("K:\\Development\\Competition")
# setwd("C:\\Users\\Greg Sanders\\Documents\\Development\\Fixed-price")
Path<-"K:\\2007-01 PROFESSIONAL SERVICES\\R scripts and data\\"
# Path<-"C:\\Users\\Greg Sanders\\SkyDrive\\Documents\\R Scripts and Data SkyDrive\\"
source(paste(Path,"lookups.r",sep=""))

```

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r setup}
MCClist  <- read.csv(
    paste("data\\defense_mcc_competition_combined.csv", sep = ""),
    header = TRUE, sep = ",", dec = ".", strip.white = TRUE, 
    na.strings = c("NULL","NA",""),
    stringsAsFactors = TRUE
    )

names(MCClist)

LMsummaryLine<-function(fit,Unit=NULL){
    data.frame(Source=as.character(summary(fit)$call)[3],
           Equation=as.character(summary(fit)$call)[2],
           Slope=coefficients(fit)[2],
           SlopeStdError=summary(fit)$coefficients[2,2],
           Intercept=coefficients(fit)[1],         
           AdjRsquared=summary(fit)$adj.r.squared,
           Pvalue=anova(fit)$'Pr(>F)'[1]
           )
    #Source: http://stackoverflow.com/questions/5587676/pull-out-p-values-and-r-squared-from-a-linear-regression
}

```

 Multiple Linear Regression Example 
 
```{r PSR}
#
# fit <- lm(y ~ x1 + x2 + x3, data=mydata)
fit <- lm(pEffectiveComp ~ pService, data=MCClist)
summary(fit) 
dfPSR<-LMsummaryLine(fit)   


fit <- lm(pEffectiveComp ~ pProduct, data=MCClist)
summary(fit) 
dfPSR<-rbind(dfPSR,LMsummaryLine(fit))

fit <- lm(pEffectiveComp ~ pRnD, data=MCClist)
summary(fit) 
dfPSR<-rbind(dfPSR,LMsummaryLine(fit))

dfPSR
```
The minimum p-value is for pRnD but `r dfPSR$Pvalue[rownames(dfPSR)=="pRnD"]`. That's far too high to use, but worth a quick closer look in case theres something going on there we're missing.

```{r RnDinspection}
fit <- lm(pEffectiveComp ~ pRnD, data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)

fit <- lm(pEffectiveComp ~ log(pRnD+0.0001), data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)
summary(fit)
dfPSR<-rbind(dfPSR,LMsummaryLine(fit))


```
Switching over ot log of RnD is significantly more promising, but still doesn't reach significance. The log of pProduct and pService were also checked, but were not promising enough to merit further inclusion.


```{r Platform}
#
# fit <- lm(y ~ x1 + x2 + x3, data=mydata)
fit <- lm(pEffectiveComp ~ pAir, data=MCClist)
summary(fit) 
dfPlatform<-LMsummaryLine(fit)

fit <- lm(pEffectiveComp ~ pVessel, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))

fit <- lm(pEffectiveComp ~ pLand, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))

fit <- lm(pEffectiveComp ~ pMnS, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))

fit <- lm(pEffectiveComp ~ pEnC, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))

fit <- lm(pEffectiveComp ~ pWnA, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))

MCClist$pPlatform<-(MCClist$pAir + MCClist$pMnS + MCClist$pVessel+MCClist$pLand+
                        MCClist$pWnA+MCClist$pEnC)
fit <- lm(pEffectiveComp ~ pPlatform, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))


MCClist$pPlatformNoLand<-(MCClist$pAir + MCClist$pMnS + MCClist$pVessel+MCClist$pWnA+MCClist$pEnC)
fit <- lm(pEffectiveComp ~ pPlatformNoLand, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))

MCClist$pPlatformNoLandOrAir<-(MCClist$pMnS + MCClist$pVessel+MCClist$pWnA+MCClist$pEnC)
fit <- lm(pEffectiveComp ~ pPlatformNoLandOrAir, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))

fit <- lm(pEffectiveComp ~ pPlatformNoLandOrAir + pAir, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))


MCClist$pWAMnS<-(MCClist$pMnS + MCClist$pWnA)
fit <- lm(pEffectiveComp ~ pWAMnS, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))

fit <- lm(pEffectiveComp ~ pAir + pWAMnS, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))


fit <- lm(pEffectiveComp ~ pAir + pWnA +pMnS, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))


View(dfPlatform)
```


```{r PlatformInspection}
fit <- lm(pEffectiveComp ~ pPlatformNoLand, data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)


fit <- lm(pEffectiveComp ~ log(pPlatformNoLand+0.0001), data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)


fit <- lm(pEffectiveComp ~ pAir + pWnA +pMnS, data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)



fit <- lm(pEffectiveComp ~ pAir , data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)

ggplot(MCClist,aes(x=as.numeric(pPlatformNoLand)))+geom_bar()
ggplot(MCClist,aes(x=log(as.numeric(pPlatformNoLand))))+geom_bar()

fit <- lm(pEffectiveComp ~ pPlatformNoLandOrAir + pAir, data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)

```

Platform No Land seems to be the best fit, but it does have a fat tail at the bottom end in the Q-Q plot. However, transforming the data does not appear to help matters.






```{r Characteristic}
#
# fit <- lm(y ~ x1 + x2 + x3, data=mydata)
fit <- lm(pEffectiveComp ~ pFixed, data=MCClist)
summary(fit) 
dfCharacteristic<-LMsummaryLine(fit)

fit <- lm(pEffectiveComp ~ pCostPlus, data=MCClist)
summary(fit) 
dfCharacteristic<-rbind(dfCharacteristic,LMsummaryLine(fit))

fit <- lm(pEffectiveComp ~ pIncentFee, data=MCClist)
summary(fit) 
dfCharacteristic<-rbind(dfCharacteristic,LMsummaryLine(fit))

fit <- lm(pEffectiveComp ~ pIDV, data=MCClist)
summary(fit) 
dfCharacteristic<-rbind(dfCharacteristic,LMsummaryLine(fit))


```

Both Incentive Fee and IDV are significant, but incentive fee has a sign opposite of what was expected by the study team. This may be driven by incentive fees often being used on larger more challenging contracts.


```{r CharacteristicInspection}
fit <- lm(pEffectiveComp ~ pIDV, data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)


fit <- lm(pEffectiveComp ~ exp(pIDV), data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
summary(fit)
plot(fit)

fit <- lm(pEffectiveComp ~ log(pIDV+0.0001), data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
summary(fit)
plot(fit)



fit <- lm(pEffectiveComp ~ pIncentFee, data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)


fit <- lm(pEffectiveComp ~ log(pIncentFee+0.0001), data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
summary(fit)
plot(fit)



```










```{r SizeAndCount}
#
# fit <- lm(y ~ x1 + x2 + x3, data=mydata)
fit <- lm(pEffectiveComp ~ log(avSize), data=MCClist)
summary(fit) 
dfSizeAndCount<-LMsummaryLine(fit)

fit <- lm(pEffectiveComp ~ avSize, data=MCClist)
summary(fit) 
dfSizeAndCount<-rbind(dfSizeAndCount,LMsummaryLine(fit))

fit <- lm(pEffectiveComp ~ log(TotalValue), data=MCClist)
summary(fit) 
dfSizeAndCount<-rbind(dfSizeAndCount,LMsummaryLine(fit))

fit <- lm(pEffectiveComp ~ log(TotalCount), data=MCClist)
summary(fit) 
dfSizeAndCount<-rbind(dfSizeAndCount,LMsummaryLine(fit))

fit <- lm(pEffectiveComp ~ log(TotalValue)+ log(TotalCount), data=MCClist)
summary(fit) 
dfSizeAndCount<-rbind(dfSizeAndCount,LMsummaryLine(fit))




```

Total Count and Total Size seem most promising, but they describe similar characterstics and of the two total count has the expected sign. Larger contracts tend to have lower rates of competition, so contracting office throughput appears to be the determining factor here with count by itself having the best p-values. We went directly to log because we are comparing greatly varied counts and dollar values, and quick checking with the untransformed values was not promising.


```{r CharacteristicInspection}
fit <- lm(pEffectiveComp ~ log(TotalCount), data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)



fit <- lm(pEffectiveComp ~ log(TotalValue), data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)



fit <- lm(pEffectiveComp ~ exp(pIDV), data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
summary(fit)
plot(fit)

fit <- lm(pEffectiveComp ~ log(pIDV+0.0001), data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
summary(fit)
plot(fit)



fit <- lm(pEffectiveComp ~ pIncentFee, data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)


fit <- lm(pEffectiveComp ~ log(pIncentFee+0.0001), data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
summary(fit)
plot(fit)


fit <- lm(pEffectiveComp ~ pAir , data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)

ggplot(MCClist,aes(x=as.numeric(pPlatformNoLand)))+geom_bar()
ggplot(MCClist,aes(x=log(as.numeric(pPlatformNoLand))))+geom_bar()

fit <- lm(pEffectiveComp ~ pPlatformNoLandOrAir + pAir, data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)

```


fitJoint <- lm(pEffectiveComp ~ pIDV+ pPlatform , data=MCClist)
summary(fitJoint) # show results
#Adding in RnD doesn't help at all





fitJoint <- lm(pEffectiveComp ~ pAir+ pMnS+ pIDV +pIncentFee  , data=MCClist)
summary(fitJoint) # show results
fitJoint <- lm(pEffectiveComp ~ pAir+ pMnS+ pIDV +pIncentFee +lavSize  , data=MCClist)
summary(fitJoint) # show results
#Incentive fee does work, though the sign is the reverse of what I expect

fitJoint <- lm(pEffectiveComp ~ pAir+ pMnS+ pIDV  , data=MCClist)
summary(fitJoint) # show results

fitJoint <- lm(pEffectiveComp ~ pPlatformResidual + pIDV , data=MCClist)
summary(fitJoint) # show results



# Other useful functions 
coefficients(fit) # model coefficients
confint(fit, level=0.95) # CIs for model parameters 
fitted(fit) # predicted values
residuals(fit) # residuals
anova(fit) # anova table 
vcov(fit) # covariance matrix for model parameters 
influence(fit) # regression diagnostics
Diagnostic Plots
Diagnostic plots provide checks for heteroscedasticity, normality, and influential observerations.
# diagnostic plots 
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)




```

You can also embed plots, for example:

```{r, echo=FALSE}
plot(cars)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
