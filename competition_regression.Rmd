---
title: "Competition_Regression"
author: "Greg Sanders"
date: "Sunday, March 15, 2015"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

```{r hiddensetup, echo = FALSE}
require(ggplot2)
require(stringr)
require(plyr)
require(Hmisc)
options(error=recover)
setwd("K:\\Development\\Competition")
# setwd("C:\\Users\\Greg Sanders\\Documents\\Development\\Fixed-price")
Path<-"K:\\2007-01 PROFESSIONAL SERVICES\\R scripts and data\\"
# Path<-"C:\\Users\\Greg Sanders\\SkyDrive\\Documents\\R Scripts and Data SkyDrive\\"
source(paste(Path,"lookups.r",sep=""))

```

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r setup}
MCClist  <- read.csv(
    paste("data\\defense_mcc_competition_combined.csv", sep = ""),
    header = TRUE, sep = ",", dec = ".", strip.white = TRUE, 
    na.strings = c("NULL","NA",""),
    stringsAsFactors = TRUE
    )

MCClist$TotalValue<-MCClist$TotalValue*1000000000
MCClist<-subset(MCClist,TotalValue>=50000000)
log10(MCClist$TotalValue)


names(MCClist)

LMsummaryLine<-function(fit,Unit=NULL){
    data.frame(  Equation=as.character(summary(fit)$call)[2],
        Source=as.character(summary(fit)$call)[3],
           Slope=coefficients(fit)[2:length(coefficients(fit))],
           SlopeStdError=summary(fit)$coefficients[2:length(coefficients(fit)),2],
           Intercept=coefficients(fit)[1],         
           AdjRsquared=summary(fit)$adj.r.squared,
            Pvalue=coef(summary(fit))[2:length(coefficients(fit)),4]
           #anova(fit)$'Pr(>F)'[1]


           )
    #Source: http://stackoverflow.com/questions/5587676/pull-out-p-values-and-r-squared-from-a-linear-regression
    #http://stackoverflow.com/questions/23838937/extract-pvalue-from-glm
}

```

 Multiple Linear Regression Example 
 
```{r PSR}
#
# fit <- lm(y ~ x1 + x2 + x3, data=mydata)

rcorr(as.matrix(subset(MCClist,select=c(pProduct,pService,pRnD))))

ggplot(data=MCClist,aes(x=pProduct,y=pEffectiveComp))+geom_point()
fit <- lm(pEffectiveComp ~ pService, data=MCClist)
summary(fit) 
dfPSR<-LMsummaryLine(fit)   
plot(fit)

ggplot(data=MCClist,aes(x=pProduct,y=pEffectiveComp))+geom_point()
fit <- lm(pEffectiveComp ~ pProduct, data=MCClist)
summary(fit) 
dfPSR<-LMsummaryLine(fit)   
plot(fit)


ggplot(data=MCClist,aes(x=pRnD,y=pEffectiveComp))+geom_point()
MCClist$pRnD[MCClist$pRnD<0]<-0
ggplot(data=MCClist,aes(x=sqrt(pRnD),y=pEffectiveComp))+geom_point()
fit <- lm(pEffectiveComp ~ pService+ sqrt(pRnD), data=MCClist)
summary(fit) 
dfPSR<-LMsummaryLine(fit)   
plot(fit)

fit <- lm(pEffectiveComp ~ pProduct+ sqrt(pRnD), data=MCClist)
summary(fit) 
dfPSR<-LMsummaryLine(fit)   
plot(fit)



View(dfPSR)
```

Because pProduct, pService, PRnD, and unlabeled data are mutually exhaustive


The minimum p-value is for the linear modpRnD but `r dfPSR$Pvalue[rownames(dfPSR)=="pRnD"]`. That's far too high to use, but worth a quick closer look in case theres something going on there we're missing.

Switching over ot log of RnD is significantly more promising, but still doesn't reach significance. The log of pProduct and pService were also checked, but were not promising enough to merit further inclusion.


```{r Platform}

rcorr(as.matrix(subset(MCClist,select=c(pProduct,pRnD,pAir,pVessel,pLand,pWnA,pMnS,pEnC))))
#Missiles and Space is highly correlated with RnD


#
# fit <- lm(y ~ x1 + x2 + x3, data=mydata)
ggplot(data=MCClist,aes(x=pAir,y=pEffectiveComp))+geom_point()
ggplot(data=MCClist,aes(x=sqrt(pAir),y=pEffectiveComp))+geom_point()
fit <- lm(pEffectiveComp ~ pProduct+sqrt(pRnD)+ pAir, data=MCClist)
summary(fit) 
dfPlatform<-LMsummaryLine(fit)
plot(fit)

fit <- lm(pEffectiveComp ~ pProduct+sqrt(pRnD)+ sqrt(pAir), data=MCClist)
summary(fit) 
dfPlatform<-LMsummaryLine(fit)
plot(fit)

#Keeping pAir without sqrt

fit <- lm(pEffectiveComp ~ pProduct + pProduct:pAir+ sqrt(pRnD)+ pAir, data=MCClist)
summary(fit) 
dfPlatform<-LMsummaryLine(fit)
plot(fit)
```


```{r pVessel}
ggplot(data=MCClist,aes(x=pVessel,y=pEffectiveComp))+geom_point()
ggplot(data=MCClist,aes(x=sqrt(pVessel),y=pEffectiveComp))+geom_point()
#Sqrt doesn't seem to illuminate much
fit <- lm(pEffectiveComp ~ pProduct+sqrt(pRnD)+ pAir+pVessel, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))

fit <- lm(pEffectiveComp ~sqrt(pRnD)+ pAir+pVessel, data=subset(MCClist,rownames(MCClist)!=58))
summary(fit) 
plot(fit)
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))

```
Leaving off vessel as it complicates products and after an outlier is removed it has a reversed sign.

```{r pLand}
#Slight reduction in R-Squared


ggplot(data=MCClist,aes(x=pLand,y=pEffectiveComp))+geom_point()
ggplot(data=MCClist,aes(x=sqrt(pLand),y=pEffectiveComp))+geom_point()

ggplot(data=MCClist,aes(x=pLand,y=pEffectiveComp))+geom_point()
fit <- lm(pEffectiveComp ~ pLand, data=MCClist)
summary(fit) 

fit <- lm(pEffectiveComp ~pProduct + sqrt(pRnD)+ pAir+pLand, data=subset(MCClist,rownames(MCClist)!=58))
summary(fit) 
plot(fit)
```

Land has a sign reversal on inclusion and reduces the F-statistic, so well leave it out.

```{r MnS}

ggplot(data=MCClist,aes(x=pMnS,y=pEffectiveComp))+geom_point()
ggplot(data=MCClist,aes(x=sqrt(pMnS),y=pEffectiveComp))+geom_point()
fit <- lm(pEffectiveComp ~ pMnS, data=MCClist)
summary(fit) 
fit <- lm(pEffectiveComp ~ sqrt(pMnS), data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))

fit <- lm(pEffectiveComp ~ sqrt(pRnD)+ pAir+pVessel+pLand, data=MCClist)
summary(fit) 

fit <- lm(pEffectiveComp ~ pAir+pVessel+pLand+sqrt(pMnS), data=MCClist)
summary(fit) 
plot(fit)

ggplot(data=MCClist,aes(x=pEnC,y=pEffectiveComp))+geom_point()
fit <- lm(pEffectiveComp ~ pEnC, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))

layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)



ggplot(data=MCClist,aes(x=pWnA,y=pEffectiveComp))+geom_point()
fit <- lm(pEffectiveComp ~ pWnA, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))


fit <- lm(pEffectiveComp ~ pWnA+  pService + I(pService^2), data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))


fit <- lm(pEffectiveComp ~ pWnA+ pAir+ pService + I(pService^2), data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))
plot(fit)

fit <- lm(pEffectiveComp ~ pWnA+ pAir+ pService + I(pService^2), data=MCClist[rownames(MCClist)!=26
                                                                                  ,])
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))
plot(fit)



MCClist$pPlatform<-(MCClist$pAir + MCClist$pMnS + MCClist$pVessel+MCClist$pLand+
                        MCClist$pWnA+MCClist$pEnC)
ggplot(data=MCClist,aes(x=pPlatform,y=pEffectiveComp))+geom_point()
fit <- lm(pEffectiveComp ~ pPlatform, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))
plot(fit)

fit <- lm(pEffectiveComp ~ pPlatform+  pService + I(pService^2), data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))


MCClist$pPlatformNoLand<-(MCClist$pAir + MCClist$pMnS + MCClist$pVessel+MCClist$pWnA+MCClist$pEnC)
ggplot(data=MCClist,aes(x=pPlatformNoLand,y=pEffectiveComp))+geom_point()
fit <- lm(pEffectiveComp ~ pPlatformNoLand, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))

fit <- lm(pEffectiveComp ~ pPlatformNoLand+  pService + I(pService^2), data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))
plot(fit)

MCClist$pPlatformNoLandOrAir<-(MCClist$pMnS + MCClist$pVessel+MCClist$pWnA+MCClist$pEnC)
ggplot(data=MCClist,aes(x=pPlatformNoLandOrAir,y=pEffectiveComp))+geom_point()
fit <- lm(pEffectiveComp ~ pPlatformNoLandOrAir, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))



fit <- lm(pEffectiveComp ~ pPlatformNoLandOrAir + pAir, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))
plot(fit)

fit <- lm(pEffectiveComp ~ pAir + pPlatformNoLandOrAir+  pService + I(pService^2), data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))
plot(fit)

MCClist$pWAMnS<-(MCClist$pMnS + MCClist$pWnA)
ggplot(data=MCClist,aes(x=log1p(pWAMnS),y=pEffectiveComp))+geom_point()
fit <- lm(pEffectiveComp ~ pWAMnS, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))



fit <- lm(pEffectiveComp ~ pWAMnS+  pService + I(pService^2), data=subset(MCClist,rownames(MCClist)!=59))
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))
plot(fit)

fit <- lm(pEffectiveComp ~ pAir + pWAMnS, data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))
plot(fit)

fit <- lm(pEffectiveComp ~ pWAMnS+ pAir+  pService + I(pService^2), data=MCClist)
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))
plot(fit)


View(dfPlatform)
```

Platform No Land seems to be the best fit, but it does have a fat tail at the bottom end in the Q-Q plot. However, transforming the data does not appear to help matters.






```{r Characteristic}
#
# fit <- lm(y ~ x1 + x2 + x3, data=mydata)
ggplot(data=MCClist,aes(x=pFixed,y=pEffectiveComp))+geom_point()
fit <- lm(pEffectiveComp ~ pFixed, data=MCClist)
summary(fit) 
dfCharacteristic<-LMsummaryLine(fit)
plot(fit)

fit <- lm(pEffectiveComp ~ pFixed + I(pFixed^2), data=MCClist)
summary(fit) 
dfCharacteristic<-rbind(dfCharacteristic,LMsummaryLine(fit))


ggplot(data=MCClist,aes(x=pCostPlus,y=pEffectiveComp))+geom_point()
fit <- lm(pEffectiveComp ~ pCostPlus , data=MCClist)
summary(fit) 
dfCharacteristic<-rbind(dfCharacteristic,LMsummaryLine(fit))



fit <- lm(pEffectiveComp ~ pCostPlus + I(pCostPlus^2), data=MCClist)
summary(fit) 
dfCharacteristic<-rbind(dfCharacteristic,LMsummaryLine(fit))

ggplot(data=MCClist,aes(x=pIncentFee,y=pEffectiveComp))+geom_point()
fit <- lm(pEffectiveComp ~ pIncentFee, data=MCClist)
summary(fit) 
dfCharacteristic<-rbind(dfCharacteristic,LMsummaryLine(fit))
plot(fit)


fit <- lm(pEffectiveComp ~ pIncentFee +pCostPlus, data=MCClist)
summary(fit) 
dfCharacteristic<-rbind(dfCharacteristic,LMsummaryLine(fit))

fit <- lm(pEffectiveComp ~ pIncentFee +pFixed, data=MCClist)
summary(fit) 
dfCharacteristic<-rbind(dfCharacteristic,LMsummaryLine(fit))

ggplot(data=MCClist,aes(x=pIDV,y=pEffectiveComp))+geom_point()
fit <- lm(pEffectiveComp ~ pIDV, data=MCClist)
summary(fit) 
dfCharacteristic<-rbind(dfCharacteristic,LMsummaryLine(fit))
plot(fit)



fit <- lm(pEffectiveComp ~ pWnA+ pAir+ pService + I(pService^2) +pFixed, data=MCClist[rownames(MCClist)!=26
                                                                                  ,])
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))
plot(fit)

fit <- lm(pEffectiveComp ~ pWnA+ pAir+ pService + I(pService^2) +pCostPlus, data=MCClist[rownames(MCClist)!=26
                                                                                  ,])
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))
plot(fit)

fit <- lm(pEffectiveComp ~ pWnA+ pAir+ pService + I(pService^2) +pIncentFee, data=MCClist[rownames(MCClist)!=26
                                                                                  ,])
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))
plot(fit)

fit <- lm(pEffectiveComp ~ pFixed+ pAir+ pService + I(pService^2) +pIDV, data=MCClist[rownames(MCClist)!=26&
                                                                                  ,])
summary(fit) 
dfPlatform<-rbind(dfPlatform,LMsummaryLine(fit))
plot(fit)






View(dfCharacteristic)

```

Both Incentive Fee and IDV are significant, but incentive fee has a sign opposite of what was expected by the study team. This may be driven by incentive fees often being used on larger more challenging contracts.


```{r CharacteristicInspection}
fit <- lm(pEffectiveComp ~ pIDV, data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)


fit <- lm(pEffectiveComp ~ exp(pIDV), data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
summary(fit)
plot(fit)

fit <- lm(pEffectiveComp ~ log(pIDV+0.0001), data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
summary(fit)
plot(fit)



fit <- lm(pEffectiveComp ~ pIncentFee, data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)

ggplot(data=MCClist,aes(x=pIncentFee,y=pEffectiveComp))+geom_point()
ggplot(data=MCClist,aes(x=log(pIncentFee+0.00001),y=pEffectiveComp))+geom_point()


fit <- lm(pEffectiveComp ~ log(pIncentFee+0.0001), data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
summary(fit)
plot(fit)



```










```{r SizeAndCount}
#
# fit <- lm(y ~ x1 + x2 + x3, data=mydata)
fit <- lm(pEffectiveComp ~ log(avSize), data=MCClist)
summary(fit) 
dfSizeAndCount<-LMsummaryLine(fit)

fit <- lm(pEffectiveComp ~ avSize, data=MCClist)
summary(fit) 
dfSizeAndCount<-rbind(dfSizeAndCount,LMsummaryLine(fit))

fit <- lm(pEffectiveComp ~ log(TotalValue), data=MCClist)
summary(fit) 
dfSizeAndCount<-rbind(dfSizeAndCount,LMsummaryLine(fit))

fit <- lm(pEffectiveComp ~ log(TotalCount), data=MCClist)
summary(fit) 
dfSizeAndCount<-rbind(dfSizeAndCount,LMsummaryLine(fit))

fit <- lm(pEffectiveComp ~ log(TotalValue)+ log(TotalCount), data=MCClist)
summary(fit) 
dfSizeAndCount<-rbind(dfSizeAndCount,LMsummaryLine(fit))




```

Total Count and Total Size seem most promising, but they describe similar characterstics and of the two total count has the expected sign. Larger contracts tend to have lower rates of competition, so contracting office throughput appears to be the determining factor here with count by itself having the best p-values. We went directly to log because we are comparing greatly varied counts and dollar values, and quick checking with the untransformed values was not promising. However, after removing an outlier with fewer than 1,000 contracts, the pattern disappears.


```{r CharacteristicInspection}
fit <- lm(pEffectiveComp ~ log(TotalCount), data=TotalCount)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)
summary(fit)
ggplot(data=MCClist,aes(x=log(TotalCount),y=pEffectiveComp))+geom_point()


fit <- lm(pEffectiveComp ~ log(TotalCount), data=subset(MCClist,log(TotalCount)>3))
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)
summary(fit)
ggplot(data=subset(MCClist,log(TotalCount)>3),aes(x=log(TotalCount),y=pEffectiveComp))+geom_point()



fit <- lm(pEffectiveComp ~ log(TotalValue), data=MCClist)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)
ggplot(data=MCClist,aes(x=log(TotalValue),y=pEffectiveComp))+geom_point()


fit <- lm(pEffectiveComp ~ log(TotalValue), data=subset(MCClist,log(TotalValue)>-2.5))
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(fit)
summary(fit)

```


fitJoint <- lm(pEffectiveComp ~ pIDV+ pPlatform , data=MCClist)
summary(fitJoint) # show results
#Adding in RnD doesn't help at all





fitJoint <- lm(pEffectiveComp ~ pAir+ pMnS+ pIDV +pIncentFee  , data=MCClist)
summary(fitJoint) # show results
fitJoint <- lm(pEffectiveComp ~ pAir+ pMnS+ pIDV +pIncentFee +lavSize  , data=MCClist)
summary(fitJoint) # show results
#Incentive fee does work, though the sign is the reverse of what I expect

fitJoint <- lm(pEffectiveComp ~ pAir+ pMnS+ pIDV  , data=MCClist)
summary(fitJoint) # show results

fitJoint <- lm(pEffectiveComp ~ pPlatformResidual + pIDV , data=MCClist)
summary(fitJoint) # show results



# Other useful functions 
# coefficients(fit) # model coefficients
# confint(fit, level=0.95) # CIs for model parameters 
#fitted(fit) # predicted values
# residuals(fit) # residuals
# anova(fit) # anova table 
#vcov(fit) # covariance matrix for model parameters 
#influence(fit) # regression diagnostics
#Diagnostic Plots
#Diagnostic plots provide checks for heteroscedasticity, normality, and influential observerations.
# diagnostic plots 
#layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
#plot(fit)


