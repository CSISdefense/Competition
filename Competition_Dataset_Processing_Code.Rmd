---
title: "Competition Dataset Processing Code"
author: "Greg Sanders"
date: "Thursday, July 02, 2015"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
require(ggplot2)
require(Hmisc)
Path<-"K:\\2007-01 PROFESSIONAL SERVICES\\R scripts and data\\"
source(paste(Path,"helper.r",sep=""))
source(paste(Path,"lookups.r",sep=""))
setwd("K:\\Development\\Competition")
source("statistics_aggregators.R")

options(error=recover)
options(warn=1)

```

You can also embed plots, for example:

```{r OfficeProcessing, echo=FALSE}
debug(statistics.pivot)
office.competition.combined<-statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerOffice.csv",
    VAR.Attribute="Competition.effective.only",
    VAR.UnitOfAnalysis="ContractingOfficeID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pCEff"  ,
    LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
)

office.competition.combined<-plyr::join(office.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerOffice.csv",
    VAR.Attribute="PlatformPortfolio.sum",
    VAR.UnitOfAnalysis="ContractingOfficeID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPlat" ,
    LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))


office.competition.combined<-plyr::join(office.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerOffice.csv",
    VAR.Attribute="ServicesCategory.sum",
    VAR.UnitOfAnalysis="ContractingOfficeID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPSR",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))
#restart here

office.competition.combined<-plyr::join(office.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerOffice.csv",
    VAR.Attribute="ProductOrServiceArea",
    VAR.UnitOfAnalysis="ContractingOfficeID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPsc",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

# debug(statistics.pivot)
office.competition.combined<-plyr::join(office.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryOffice.csv",
    VAR.Attribute="Pricing.Mechanism.hypothesis.detail",
    VAR.UnitOfAnalysis="ContractingOfficeID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPrice",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

office.competition.combined<-plyr::join(office.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryOffice.csv",
    VAR.Attribute="Pricing.Mechanism.Fee",
    VAR.UnitOfAnalysis="ContractingOfficeID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pFee",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))


office.competition.combined<-plyr::join(office.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryOffice.csv",
    VAR.Attribute="Vehicle.IDVorAward",
    VAR.UnitOfAnalysis="ContractingOfficeID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pIDV",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))
# debug(statistics.pivot)
office.competition.combined<-plyr::join(office.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryOffice.csv",
    VAR.Attribute="Vehicle.hypothesis",
    VAR.UnitOfAnalysis="ContractingOfficeID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pVeh",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

office.competition.combined<-plyr::join(office.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryOffice.csv",
    VAR.Attribute="Competition.detail",
    VAR.UnitOfAnalysis="ContractingOfficeID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pComp",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

# 
# office.competition.combined<-competition.statistics(
#     "",
#     "data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerOffice.csv",
#     "ContractingOfficeID"
# )
# # debug(competition.statistics.offers)

# debug(competition.statistics.offers)
office.competition.combined<-plyr::join(office.competition.combined,competition.statistics.offers(
    Path,
    "data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryOffice.csv",
    "ContractingOfficeID",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
)
)


office.competition.combined<-plyr::join(office.competition.combined,
                                        competition.statistics.size(Path
                                                                    ,"data\\Defense_Contract_SP_ContractSizeforCompetitionStudyOffice.csv"
                                                                    ,"ContractingOfficeID",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
                                        )
)

summary(office.competition.combined)

office.competition.combined$TotalThreshold<- cut2(office.competition.combined$TotalValue,cuts=c(0,1000000,5000000,100000000,1000000000))
office.competition.combined$AnnualThreshold<- cut2(office.competition.combined$MaxAnnualValue,cuts=c(0,1000000,5000000,50000000,100000000))
ggplot(data=office.competition.combined,
       aes(x=TotalValue,fill=TotalThreshold))+geom_bar()+scale_x_log10(labels = comma)#bin=0.01))


ggplot(data=office.competition.combined,
       aes(x=MaxAnnualValue,fill=AnnualThreshold))+geom_bar()+scale_x_log10(labels = comma)+#bin=0.01))+
    facet_wrap(~TotalThreshold,ncol=1)



office.competition.combined$ExcludeLow[office.competition.combined$MaxAnnualValue<1000000 | 
                                        office.competition.combined$TotalValue<5000000]<-TRUE
office.competition.combined$ExcludeLow[office.competition.combined$MaxAnnualValue>=1000000 & 
                                        office.competition.combined$TotalValue>=5000000]<-FALSE
summary(office.competition.combined$ExcludeLow)

office.competition.combined$ExcludeHigh[office.competition.combined$MaxAnnualValue<50000000 &
                                           office.competition.combined$TotalValue<1000000000]<-TRUE
office.competition.combined$ExcludeHigh[office.competition.combined$MaxAnnualValue>=50000000 |
                                           office.competition.combined$TotalValue>=1000000000]<-FALSE
summary(office.competition.combined$ExcludeHigh)

ecdf(office.competition.combined$TotalValue)(c(1000000,10000000,1000000000))
tapply(office.competition.combined$TotalValue/1000000000, office.competition.combined$TotalThreshold, sum)
tapply(office.competition.combined$TotalValue/1000000000, office.competition.combined$TotalThreshold, length)
tapply(office.competition.combined$TotalValue/1000000000, office.competition.combined$AnnualThreshold, sum)
tapply(office.competition.combined$TotalValue/1000000000, office.competition.combined$AnnualThreshold, length)
tapply(office.competition.combined$TotalValue/1000000000, office.competition.combined$ExcludeHigh, sum)
tapply(office.competition.combined$TotalValue/1000000000, office.competition.combined$ExcludeHigh, length)


write.table(subset(office.competition.combined,select=-c(TotalThreshold,AnnualThreshold))
            ,file="data\\defense_office_competition_combined_2000-2013.csv"
            #   ,header=TRUE
            , sep=","
            , row.names=FALSE
            , append=FALSE
)

``` 


```{r MCCprocessing, echo=FALSE}
mcc.competition.combined<-statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerMajorCommand.csv",
    VAR.Attribute="Competition.effective.only",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pCEff",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
)

mcc.competition.combined<-plyr::join(mcc.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerMajorCommand.csv",
    VAR.Attribute="PlatformPortfolio.sum",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPlat",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

mcc.competition.combined<-plyr::join(mcc.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerMajorCommand.csv",
    VAR.Attribute="SimpleArea",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Mixed or Unlabeled",
    ColumnPrefix="pPSR",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))


mcc.competition.combined<-plyr::join(mcc.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerMajorCommand.csv",
    VAR.Attribute="ProductOrServiceArea",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPsc",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

# debug(statistics.pivot)
mcc.competition.combined<-plyr::join(mcc.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryMajorCommand.csv",
    VAR.Attribute="Pricing.Mechanism.hypothesis.detail",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPrice",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

mcc.competition.combined<-plyr::join(mcc.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryMajorCommand.csv",
    VAR.Attribute="Pricing.Mechanism.Fee",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pFee",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))


mcc.competition.combined<-plyr::join(mcc.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryMajorCommand.csv",
    VAR.Attribute="Vehicle.IDVorAward",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pIDV",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))
# debug(statistics.pivot)
mcc.competition.combined<-plyr::join(mcc.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryMajorCommand.csv",
    VAR.Attribute="Vehicle.hypothesis",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pVeh",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

mcc.competition.combined<-plyr::join(mcc.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryMajorCommand.csv",
    VAR.Attribute="Competition.detail",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pComp",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))


mcc.competition.combined<-plyr::join(mcc.competition.combined,competition.statistics.offers(
    Path,
    "data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryMajorCommand.csv",
    "MajorCommandID",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
)
)


mcc.competition.combined<-plyr::join(mcc.competition.combined,
                                        competition.statistics.size(Path
                                                                    ,"data\\Defense_Contract_SP_ContractSizeforCompetitionStudyMajorCommand.csv"
                                                                    ,"MajorCommandID",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
                                        )
)

summary(mcc.competition.combined)


mcc.competition.combined$TotalThreshold<- cut2(mcc.competition.combined$TotalValue,cuts=c(1000000,10000000,100000000))
mcc.competition.combined$AnnualThreshold<- cut2(mcc.competition.combined$MaxAnnualValue,cuts=c(1000000,10000000,100000000))
mcc.competition.combined$Exclude[mcc.competition.combined$MajorCommandID %in% c("ORG-2841",
                                                                                "ORG-2776",
                                                                                "ORG-4793",
                                                                                "ORG-2849",
                                                                                "ORG-2762",
                                                                                "ORG-4020",
                                                                                "ORG-2840",
                                                                                "ORG-2757"
)]<-TRUE




summary(mcc.competition.combined$Threshold)
summary(mcc.competition.combined[mcc.competition.combined$MajorCommandID %in% c("ORG-2841",
                                                                                "ORG-2776",
                                                                                "ORG-4793",
                                                                                "ORG-2849",
                                                                                "ORG-2762",
                                                                                "ORG-4020",
                                                                                "ORG-2840",
                                                                                "ORG-2757"),c("TotalValue","MaxAnnualValue")]
)
summary(mcc.competition.combined[!mcc.competition.combined$MajorCommandID %in% c("ORG-2841",
                                                                                 "ORG-2776",
                                                                                 "ORG-4793",
                                                                                 "ORG-2849",
                                                                                 "ORG-2762",
                                                                                 "ORG-4020",
                                                                                 "ORG-2840",
                                                                                 "ORG-2757"),c("TotalValue","MaxAnnualValue")]
)
# 
# ggplot(data=mcc.competition.combined,
#        aes(x=MaxAnnualValue,fill=Threshold))+geom_bar()+scale_x_log10(labels = comma)+#bin=0.01))+
#     facet_wrap(~Exclude,ncol=1)
# 
# 
# ggplot(data=mcc.competition.combined,
#        aes(x=TotalValue,fill=Threshold))+geom_bar()+scale_x_log10(labels = comma)+#bin=0.01))+
#     facet_wrap(~Exclude,ncol=1)


MCCshortList<-subset(mcc.competition.combined,!MajorCommandID %in% c("ORG-2841",
                                                                     "ORG-2776",
                                                                     "ORG-4793",
                                                                     "ORG-2849",
                                                                     "ORG-2762",
                                                                     "ORG-4020",
                                                                     "ORG-2840",
                                                                     "ORG-2757")
)

mcc.competition.combined$Exclude<-FALSE
mcc.competition.combined$Exclude[mcc.competition.combined$MajorCommandID %in% c("ORG-2841",
                                                                     "ORG-2776",
                                                                     "ORG-4793",
                                                                     "ORG-2849",
                                                                     "ORG-2762",
                                                                     "ORG-4020",
                                                                     "ORG-2840",
                                                                     "ORG-2757")]<-TRUE

write.table(mcc.competition.combined
            ,file="data\\defense_mcc_competition_combined_2000-2013.csv"
            #   ,header=TRUE
            , sep=","
            , row.names=FALSE
            , append=FALSE
)

``` 











```{r StateProcessing, echo=FALSE}
state.competition.combined<-statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_location_SP_DefenseCompetitionPoPstateHistoryBucketPlatformSubCustomer.csv",
    VAR.Attribute="Competition.effective.only",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pCEff",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
)

state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_location_SP_DefenseCompetitionPoPstateHistoryBucketPlatformSubCustomer.csv",
    VAR.Attribute="PlatformPortfolio.sum",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPlat",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_location_SP_DefenseCompetitionPoPstateHistoryBucketPlatformSubCustomer.csv",
    VAR.Attribute="SimpleArea",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Mixed or Unlabeled",
    ColumnPrefix="pPSR",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))
# 

state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_location_SP_DefenseCompetitionPoPstateHistoryBucketPlatformSubCustomer.csv",
    VAR.Attribute="ProductOrServiceArea",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPsc",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))


state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Location_SP_DefenseCompetitionPricingVehiclePoPstateHistory.csv",
    VAR.Attribute="Pricing.Mechanism.hypothesis.detail",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPrice",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Location_SP_DefenseCompetitionPricingVehiclePoPstateHistory.csv",
    VAR.Attribute="Pricing.Mechanism.Fee",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pFee",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))


state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Location_SP_DefenseCompetitionPricingVehiclePoPstateHistory.csv",
    VAR.Attribute="Vehicle.IDVorAward",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pIDV",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

# debug(statistics.pivot)
state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Location_SP_DefenseCompetitionPricingVehiclePoPstateHistory.csv",
    VAR.Attribute="Vehicle.hypothesis",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pVeh",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Location_SP_DefenseCompetitionPricingVehiclePoPstateHistory.csv",
    VAR.Attribute="Competition.detail",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pComp",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))


state.competition.combined<-plyr::join(state.competition.combined,competition.statistics.offers(
    Path,
    "data\\defense_Location_SP_DefenseCompetitionPricingVehiclePoPstateHistory.csv",
    "PoPstateCode",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
)
)


state.competition.combined<-plyr::join(state.competition.combined,
                                        competition.statistics.size(Path
                                                                    ,"data\\Defense_Location_SP_ContractSizeforCompetitionStudy.csv"
                                                                    ,"PoPstateCode",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
                                        )
)

summary(state.competition.combined)


state.competition.combined$Exclude<-FALSE
state.competition.combined$Exclude[state.competition.combined$PoPstateCode %in% c("VI",
                                                                         "AS",
                                                                         "MP",
                                                                         "AE",
                                                                         "PW",
                                                                         "US",
                                                                         "UK",
                                                                         "GM",
                                                                         "GB",
                                                                         "JA",
                                                                         "ON",
                                                                         "QC",
                                                                         "   ",
                                                                         "BC")]<-TRUE


# 
# StateFit <- lm(pEffectiveComp ~
#                    pAir  +
#                    pMnS +
#                    pEnC +
#                    pIDV+ 
#                    pVessel+
#                    pProduct+
#                    pEnC:pProduct, 
#                data=ShortStateList)
# summary(StateFit) 
# plot(StateFit)


write.table(state.competition.combined
            ,file="data\\defense_state_competition_combined_2000-2013.csv"
            #   ,header=TRUE
            , sep=","
            , row.names=FALSE
            , append=FALSE
)


# state.competition.combined<-cbind(state.competition.combined,predict(StateFit,state.competition.combined,interval="prediction",level=0.95))
# subset(state.competition.combined,lwr>pEffectiveComp|upr<pEffectiveComp)$PoPstateCode
# 
# 
# 
# state.competition.2014<-competition.statistics(
#     "",
#     "data\\2014DefenseCompetitionByPlatformAreaPoP.csv",
#     "PoPstateCode",
#     2014
# )
# 
# 
# state.competition.2014<-plyr::join(state.competition.2014,competition.statistics.offers(""
#                                                                                         ,"data\\2014DefenseCompetitionVehicleByPlatformAreaPoP.csv"
#                                                                                         ,"PoPstateCode"
#                                                                                         ,2014
# )
# )
# 
# state.competition.2014<-cbind(state.competition.2014,
#                               predict(StateFit,
#                                       state.competition.2014,
#                                       interval="prediction",
#                                       level=0.95)
# )
# subset(state.competition.2014,lwr>pEffectiveComp|upr<pEffectiveComp)$PoPstateCode
# 
# 
# 
# 
# write.table(state.competition.2014
#             ,file="Output\\2014_defense_state_competition_combined.csv"
#             #   ,header=TRUE
#             , sep=","
#             , row.names=FALSE
#             , append=FALSE
# )
# 
# write.table(state.competition.combined
#             ,file="Output\\2000_2013_defense_state_competition_combined.csv"
#             #   ,header=TRUE
#             , sep=","
#             , row.names=FALSE
#             , append=FALSE
# )


``` 






```{r Classic}
# mcc.competition.combined<-competition.statistics(
#     "",
#     "data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerMajorCommand.csv",
#     "MajorCommandID"
# )
# # debug(competition.statistics.offers)
# mcc.competition.combined<-plyr::join(mcc.competition.combined,competition.statistics.offers(
#     "",
#     "data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryMajorCommand.csv",
#     "MajorCommandID"
# )
# )
# 
# mcc.competition.combined<-plyr::join(mcc.competition.combined,competition.statistics.size(""
#                                                                                           ,"data\\Defense_Office_SP_ContractSizeforCompetitionStudy.csv"
#                                                                                           ,"MajorCommandID"
# )
# )
# 
# 
# MCC.fit <- lm(pEffectiveComp ~ 
#                   pService:pProduct+ 
#                   pAir  +
#                   pMnS +
#                   pWnA +
#                   pEnC  +
#                   pIDV +
#                   pService +
#                   pService:pIDV +
#                   pProduct:pService:pIDV
#               , data=MCCshortList)
# summary(MCC.fit) 
# plot(MCC.fit)
# 
# 
# mcc.competition.combined<-cbind(mcc.competition.combined,predict(MCC.fit,mcc.competition.combined,interval="prediction",level=0.95))
# subset(mcc.competition.combined,lwr>pEffectiveComp|upr<pEffectiveComp)$MajorCommandID
# 
# 
# 
# 
# 
# mcc.competition.2014<-competition.statistics(
#     "",
#     "data\\2014DefenseCompetitionByPlatformAreaMajorCommand.csv",
#     "MajorCommandID",
#     2014
# )
# 
# 
# mcc.competition.2014<-plyr::join(mcc.competition.2014,competition.statistics.offers(
#     "",
#     "data\\2014DefenseCompetitionVehicleByPlatformAreaMajorCommand.csv",
#     "MajorCommandID",
#     2014
# )
# )
# 
# mcc.competition.2014<-cbind(mcc.competition.2014,
#                             predict(MCC.fit,
#                                     mcc.competition.2014,
#                                     interval="prediction",
#                                     level=0.95)
# )
# subset(mcc.competition.2014,lwr>pEffectiveComp|upr<pEffectiveComp)$MajorCommandID
# 
# 
# 
# 
# write.table(mcc.competition.2014
#             ,file="Output\\2014_defense_MCC_competition_combined.csv"
#             #   ,header=TRUE
#             , sep=","
#             , row.names=FALSE
#             , append=FALSE
# )
# 
# 
# 
# write.table(mcc.competition.combined
#             ,file="Output\\2000_2013_defense_mcc_competition_combined.csv"
#             #   ,header=TRUE
#             , sep=","
#             , row.names=FALSE
#             , append=FALSE
# )
# 
# 
# state.competition.combined<-competition.statistics(""
#                                                    ,"data\\defense_Location_SP_DefenseCompetitionStatePoPHistoryBucketPlatform.csv"
#                                                    ,"PoPstateCode"
# )
# # debug(competition.statistics.offers)
# state.competition.combined<-plyr::join(state.competition.combined,competition.statistics.offers(""
#                                                                                                 ,"data\\defense_Location_SP_DefenseCompetitionPricingVehiclePoPstateHistory.csv","
#                                                                                                 ,"PoPstateCode"
# )
# )
# 
# state.competition.combined<-plyr::join(state.competition.combined,competition.statistics.size(""
#                                                                                               ,"data\\Defense_Location_SP_ContractSizeforCompetitionStudy.csv"
#                                                                                               ,"PoPstateCode"
# )
# )
# 
# 
# 
# ShortStateList <-subset(state.competition.combined ,!PoPstateCode %in% c("VI",
#                                                                          "AS",
#                                                                          "MP",
#                                                                          "AE",
#                                                                          "PW",
#                                                                          "US",
#                                                                          "UK",
#                                                                          "GM",
#                                                                          "GB",
#                                                                          "JA",
#                                                                          "ON",
#                                                                          "QC",
#                                                                          "   ",
#                                                                          "BC"))
# 
# 
# 
# StateFit <- lm(pEffectiveComp ~
#                    pAir  +
#                    pMnS +
#                    pEnC +
#                    pIDV+ 
#                    pVessel+
#                    pProduct+
#                    pEnC:pProduct, 
#                data=ShortStateList)
# summary(StateFit) 
# plot(StateFit)
# 
# 
# write.table(state.competition.combined
#             ,file="data\\defense_state_competition_combined.csv"
#             #   ,header=TRUE
#             , sep=","
#             , row.names=FALSE
#             , append=FALSE
# )
# 
# 
# state.competition.combined<-cbind(state.competition.combined,predict(StateFit,state.competition.combined,interval="prediction",level=0.95))
# subset(state.competition.combined,lwr>pEffectiveComp|upr<pEffectiveComp)$PoPstateCode
# 
# 
# 
# state.competition.2014<-competition.statistics(
#     "",
#     "data\\2014DefenseCompetitionByPlatformAreaPoP.csv",
#     "PoPstateCode",
#     2014
# )
# 
# 
# state.competition.2014<-plyr::join(state.competition.2014,competition.statistics.offers(""
#                                                                                         ,"data\\2014DefenseCompetitionVehicleByPlatformAreaPoP.csv"
#                                                                                         ,"PoPstateCode"
#                                                                                         ,2014
# )
# )
# 
# state.competition.2014<-cbind(state.competition.2014,
#                               predict(StateFit,
#                                       state.competition.2014,
#                                       interval="prediction",
#                                       level=0.95)
# )
# subset(state.competition.2014,lwr>pEffectiveComp|upr<pEffectiveComp)$PoPstateCode
# 
# 
# 
# 
# write.table(state.competition.2014
#             ,file="Output\\2014_defense_state_competition_combined.csv"
#             #   ,header=TRUE
#             , sep=","
#             , row.names=FALSE
#             , append=FALSE
# )
# 
# write.table(state.competition.combined
#             ,file="Output\\2000_2013_defense_state_competition_combined.csv"
#             #   ,header=TRUE
#             , sep=","
#             , row.names=FALSE
#             , append=FALSE
# )


# state.competition.massive <-read.csv(
#   paste(Path,"data\\defense_Location_SP_DefenseCompetitionStatePoPHistoryBucketPlatform.csv",sep=""),
#   header=TRUE, sep=",", dec=".", strip.white=TRUE, 
#   na.strings="NULL",
#   stringsAsFactors=TRUE
# )


# debug(apply_lookups)
# state.competition.massive<-apply_lookups(Path,state.competition.massive)

# state.competition.combined<-competition.statistics(state.competition.massive,"PoPstateCode")


# state.competition$SumOf

# 
# 
# #"defense_SumofObligatedAmount_SumOfbaseandexercisedoptionsvalue_StartFiscal_Year_exercisedweighted"
# 
# SpentvExpected<-qplot(log10(SumofObligatedAmount)
#                       ,log10(SumOfbaseandexercisedoptionsvalue)
#                       ,data=mcc.competition[sample(nrow(mcc.competition), size=15000, prob=abs(mcc.competition$SumofObligatedAmount)),]
#                       ,color=IsIDV
# )+facet_wrap(IsIDV~StartFiscal_Year)
# 
# png(
#   paste(Path
#         
#         ,"defense_SumofObligatedAmount_SumOfbaseandexercisedoptionsvalue_StartFiscal_Year_obligationweighted"
#         ,".png"
#         , sep=""
#   )
#   , width=6#VAR.width
#   , height=6#VAR.height
#   , units='in'
#   , res=300
# )
# 
# print(SpentvExpected)
# 
# if (!(dev.cur()[[1]]==1)){
#   dev.off()
# }
# 
# #"defense_SumofObligatedAmount_Sumofbaseandalloptionsvalue_StartFiscal_Year_obligationweighted"
# SpentvExpected<-qplot(log10(SumofObligatedAmount)
#                       ,log10(Sumofbaseandalloptionsvalue)
#                       ,data=mcc.competition[sample(nrow(mcc.competition), size=15000, prob=abs(mcc.competition$SumofObligatedAmount)),]
#                       ,color=IsIDV
# )+facet_wrap(StartFiscal_Year~IsIDV)
# 
# 
# png(
#   paste(Path
#         
#         ,"defense_SumofObligatedAmount_Sumofbaseandalloptionsvalue_StartFiscal_Year_obligationweighted"
#         ,".png"
#         , sep=""
#   )
#   , width=6#VAR.width
#   , height=6#VAR.height
#   , units='in'
#   , res=300
# )
# 
# print(SpentvExpected)
# 
# if (!(dev.cur()[[1]]==1)){
#   dev.off()
# }
# 
# mcc.competition<-subset(mcc.competition,!is.na(SumOfbaseandexercisedoptionsvalue)&!is.na(Sumofbaseandalloptionsvalue))
# 
# 
# #"defense_SumofObligatedAmount_SumOfbaseandexercisedoptionsvalue_StartFiscal_Year_exercisedweighted"
# SpentvExpected<-qplot(log10(SumofObligatedAmount)
#                       ,log10(SumOfbaseandexercisedoptionsvalue)
#                       ,data=mcc.competition[sample(nrow(mcc.competition), size=15000, prob=abs(mcc.competition$SumOfbaseandexercisedoptionsvalue)),]
#                       ,color=IsIDV
# )+facet_wrap(StartFiscal_Year~IsIDV)
# 
# 
# png(
#   paste(Path
#         
#         ,"defense_SumofObligatedAmount_SumOfbaseandexercisedoptionsvalue_StartFiscal_Year_exercisedweighted"
#         ,".png"
#         , sep=""
#   )
#   , width=6#VAR.width
#   , height=6#VAR.height
#   , units='in'
#   , res=300
# )
# 
# print(SpentvExpected)
# 
# if (!(dev.cur()[[1]]==1)){
#   dev.off()
# }
# 
# 
# #"defense_SumofObligatedAmount_Sumofbaseandalloptionsvalue_StartFiscal_Year_allweighted"
# SpentvExpected<-qplot(log10(SumofObligatedAmount)
#                       ,log10(Sumofbaseandalloptionsvalue)
#                       ,data=mcc.competition[sample(nrow(mcc.competition), size=15000, prob=abs(mcc.competition$Sumofbaseandalloptionsvalue)),]
#                       ,color=IsIDV
# )+facet_wrap(StartFiscal_Year~IsIDV)
# 
# 
# png(
#   paste(Path
#         
#         ,"defense_SumofObligatedAmount_Sumofbaseandalloptionsvalue_StartFiscal_Year_allweighted"
#         ,".png"
#         , sep=""
#   )
#   , width=6#VAR.width
#   , height=6#VAR.height
#   , units='in'
#   , res=300
# )
# 
# print(SpentvExpected)
# 
# if (!(dev.cur()[[1]]==1)){
#   dev.off()
# }
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
