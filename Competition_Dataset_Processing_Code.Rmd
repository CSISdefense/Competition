---
title: "Competition Dataset Processing Code"
author: "Greg Sanders"
date: "Thursday, July 02, 2015"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
require(ggplot2)
require(Hmisc)
Path<-"K:\\2007-01 PROFESSIONAL SERVICES\\R scripts and data\\"
source(paste(Path,"helper.r",sep=""))
source(paste(Path,"lookups.r",sep=""))
setwd("K:\\Development\\Competition")
source("statistics_aggregators.R")

options(error=recover)
options(warn=1)

```

You can also embed plots, for example:

```{r OfficeProcessing2000-2013, echo=FALSE}
debug(statistics.pivot)
office.competition.combined<-statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerOffice.csv",
    VAR.Attribute="Competition.effective.only",
    VAR.UnitOfAnalysis="ContractingOfficeID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pCEff"  ,
    LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
)

office.competition.combined<-plyr::join(office.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerOffice.csv",
    VAR.Attribute="PlatformPortfolio.sum",
    VAR.UnitOfAnalysis="ContractingOfficeID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPlat" ,
    LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))


office.competition.combined<-plyr::join(office.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerOffice.csv",
    VAR.Attribute="ServicesCategory.sum",
    VAR.UnitOfAnalysis="ContractingOfficeID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPSR",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))
#restart here

office.competition.combined<-plyr::join(office.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerOffice.csv",
    VAR.Attribute="ProductOrServiceArea",
    VAR.UnitOfAnalysis="ContractingOfficeID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPsc",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

# debug(statistics.pivot)
office.competition.combined<-plyr::join(office.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryOffice.csv",
    VAR.Attribute="Pricing.Mechanism.hypothesis.detail",
    VAR.UnitOfAnalysis="ContractingOfficeID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPrice",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

office.competition.combined<-plyr::join(office.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryOffice.csv",
    VAR.Attribute="Pricing.Mechanism.Fee",
    VAR.UnitOfAnalysis="ContractingOfficeID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pFee",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))


office.competition.combined<-plyr::join(office.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryOffice.csv",
    VAR.Attribute="Vehicle.IDVorAward",
    VAR.UnitOfAnalysis="ContractingOfficeID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pIDV",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))
# debug(statistics.pivot)
office.competition.combined<-plyr::join(office.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryOffice.csv",
    VAR.Attribute="Vehicle.hypothesis",
    VAR.UnitOfAnalysis="ContractingOfficeID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pVeh",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

office.competition.combined<-plyr::join(office.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryOffice.csv",
    VAR.Attribute="Competition.detail",
    VAR.UnitOfAnalysis="ContractingOfficeID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pComp",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

# 
# office.competition.combined<-competition.statistics(
#     "",
#     "data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerOffice.csv",
#     "ContractingOfficeID"
# )
# # debug(competition.statistics.offers)

# debug(competition.statistics.offers)
office.competition.combined<-plyr::join(office.competition.combined,competition.statistics.offers(
    Path,
    "data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryOffice.csv",
    "ContractingOfficeID",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
)
)


office.competition.combined<-plyr::join(office.competition.combined,
                                        competition.statistics.size(Path
                                                                    ,"data\\Defense_Contract_SP_ContractSizeforCompetitionStudyOffice.csv"
                                                                    ,"ContractingOfficeID",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
                                        )
)

summary(office.competition.combined)

office.competition.combined$TotalThreshold<- cut2(office.competition.combined$TotalValue,cuts=c(0,1000000,5000000,100000000,1000000000))
office.competition.combined$AnnualThreshold<- cut2(office.competition.combined$MaxAnnualValue,cuts=c(0,1000000,5000000,50000000,100000000))
ggplot(data=office.competition.combined,
       aes(x=TotalValue,fill=TotalThreshold))+geom_bar()+scale_x_log10(labels = comma)#bin=0.01))


ggplot(data=office.competition.combined,
       aes(x=MaxAnnualValue,fill=AnnualThreshold))+geom_bar()+scale_x_log10(labels = comma)+#bin=0.01))+
    facet_wrap(~TotalThreshold,ncol=1)



office.competition.combined$ExcludeLow[office.competition.combined$MaxAnnualValue<1000000 | 
                                        office.competition.combined$TotalValue<5000000]<-TRUE
office.competition.combined$ExcludeLow[office.competition.combined$MaxAnnualValue>=1000000 & 
                                        office.competition.combined$TotalValue>=5000000]<-FALSE
summary(office.competition.combined$ExcludeLow)

office.competition.combined$ExcludeHigh[office.competition.combined$MaxAnnualValue<50000000 &
                                           office.competition.combined$TotalValue<1000000000]<-TRUE
office.competition.combined$ExcludeHigh[office.competition.combined$MaxAnnualValue>=50000000 |
                                           office.competition.combined$TotalValue>=1000000000]<-FALSE
summary(office.competition.combined$ExcludeHigh)

ecdf(office.competition.combined$TotalValue)(c(1000000,10000000,1000000000))
tapply(office.competition.combined$TotalValue/1000000000, office.competition.combined$TotalThreshold, sum)
tapply(office.competition.combined$TotalValue/1000000000, office.competition.combined$TotalThreshold, length)
tapply(office.competition.combined$TotalValue/1000000000, office.competition.combined$AnnualThreshold, sum)
tapply(office.competition.combined$TotalValue/1000000000, office.competition.combined$AnnualThreshold, length)
tapply(office.competition.combined$TotalValue/1000000000, office.competition.combined$ExcludeHigh, sum)
tapply(office.competition.combined$TotalValue/1000000000, office.competition.combined$ExcludeHigh, length)


write.table(subset(office.competition.combined,select=-c(TotalThreshold,AnnualThreshold))
            ,file="data\\defense_office_competition_combined_2000-2013.csv"
            #   ,header=TRUE
            , sep=","
            , row.names=FALSE
            , append=FALSE
)

``` 


```{r MCCprocessing2000-2013, echo=FALSE}
mcc.competition.combined<-statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerMajorCommand.csv",
    VAR.Attribute="Competition.effective.only",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pCEff",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
)

mcc.competition.combined<-plyr::join(mcc.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerMajorCommand.csv",
    VAR.Attribute="PlatformPortfolio.sum",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPlat",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

mcc.competition.combined<-plyr::join(mcc.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerMajorCommand.csv",
    VAR.Attribute="SimpleArea",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Mixed or Unlabeled",
    ColumnPrefix="pPSR",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))


mcc.competition.combined<-plyr::join(mcc.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerMajorCommand.csv",
    VAR.Attribute="ProductOrServiceArea",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPsc",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

# debug(statistics.pivot)
mcc.competition.combined<-plyr::join(mcc.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryMajorCommand.csv",
    VAR.Attribute="Pricing.Mechanism.hypothesis.detail",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPrice",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

mcc.competition.combined<-plyr::join(mcc.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryMajorCommand.csv",
    VAR.Attribute="Pricing.Mechanism.Fee",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pFee",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))


mcc.competition.combined<-plyr::join(mcc.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryMajorCommand.csv",
    VAR.Attribute="Vehicle.IDVorAward",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pIDV",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))
# debug(statistics.pivot)
mcc.competition.combined<-plyr::join(mcc.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryMajorCommand.csv",
    VAR.Attribute="Vehicle.hypothesis",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pVeh",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

mcc.competition.combined<-plyr::join(mcc.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryMajorCommand.csv",
    VAR.Attribute="Competition.detail",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pComp",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))


mcc.competition.combined<-plyr::join(mcc.competition.combined,competition.statistics.offers(
    Path,
    "data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryMajorCommand.csv",
    "MajorCommandID",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
)
)


mcc.competition.combined<-plyr::join(mcc.competition.combined,
                                        competition.statistics.size(Path
                                                                    ,"data\\Defense_Contract_SP_ContractSizeforCompetitionStudyMajorCommand.csv"
                                                                    ,"MajorCommandID",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
                                        )
)

summary(mcc.competition.combined)


mcc.competition.combined$TotalThreshold<- cut2(mcc.competition.combined$TotalValue,cuts=c(1000000,10000000,100000000))
mcc.competition.combined$AnnualThreshold<- cut2(mcc.competition.combined$MaxAnnualValue,cuts=c(1000000,10000000,100000000))
mcc.competition.combined$Exclude[mcc.competition.combined$MajorCommandID %in% c("ORG-2841",
                                                                                "ORG-2776",
                                                                                "ORG-4793",
                                                                                "ORG-2849",
                                                                                "ORG-2762",
                                                                                "ORG-4020",
                                                                                "ORG-2840",
                                                                                "ORG-2757"
)]<-TRUE




summary(mcc.competition.combined$Threshold)
summary(mcc.competition.combined[mcc.competition.combined$MajorCommandID %in% c("ORG-2841",
                                                                                "ORG-2776",
                                                                                "ORG-4793",
                                                                                "ORG-2849",
                                                                                "ORG-2762",
                                                                                "ORG-4020",
                                                                                "ORG-2840",
                                                                                "ORG-2757"),c("TotalValue","MaxAnnualValue")]
)
summary(mcc.competition.combined[!mcc.competition.combined$MajorCommandID %in% c("ORG-2841",
                                                                                 "ORG-2776",
                                                                                 "ORG-4793",
                                                                                 "ORG-2849",
                                                                                 "ORG-2762",
                                                                                 "ORG-4020",
                                                                                 "ORG-2840",
                                                                                 "ORG-2757"),c("TotalValue","MaxAnnualValue")]
)
# 
# ggplot(data=mcc.competition.combined,
#        aes(x=MaxAnnualValue,fill=Threshold))+geom_bar()+scale_x_log10(labels = comma)+#bin=0.01))+
#     facet_wrap(~Exclude,ncol=1)
# 
# 
# ggplot(data=mcc.competition.combined,
#        aes(x=TotalValue,fill=Threshold))+geom_bar()+scale_x_log10(labels = comma)+#bin=0.01))+
#     facet_wrap(~Exclude,ncol=1)


MCCshortList<-subset(mcc.competition.combined,!MajorCommandID %in% c("ORG-2841",
                                                                     "ORG-2776",
                                                                     "ORG-4793",
                                                                     "ORG-2849",
                                                                     "ORG-2762",
                                                                     "ORG-4020",
                                                                     "ORG-2840",
                                                                     "ORG-2757")
)

mcc.competition.combined$Exclude<-FALSE
mcc.competition.combined$Exclude[mcc.competition.combined$MajorCommandID %in% c("ORG-2841",
                                                                     "ORG-2776",
                                                                     "ORG-4793",
                                                                     "ORG-2849",
                                                                     "ORG-2762",
                                                                     "ORG-4020",
                                                                     "ORG-2840",
                                                                     "ORG-2757")]<-TRUE

write.table(mcc.competition.combined
            ,file="data\\defense_mcc_competition_combined_2000-2013.csv"
            #   ,header=TRUE
            , sep=","
            , row.names=FALSE
            , append=FALSE
)

``` 





```{r StateProcessing2000-2013, echo=FALSE}
state.competition.combined<-statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_location_SP_DefenseCompetitionPoPstateHistoryBucketPlatformSubCustomer.csv",
    VAR.Attribute="Competition.effective.only",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pCEff",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
)

state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_location_SP_DefenseCompetitionPoPstateHistoryBucketPlatformSubCustomer.csv",
    VAR.Attribute="PlatformPortfolio.sum",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPlat",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_location_SP_DefenseCompetitionPoPstateHistoryBucketPlatformSubCustomer.csv",
    VAR.Attribute="SimpleArea",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Mixed or Unlabeled",
    ColumnPrefix="pPSR",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))
# 

state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_location_SP_DefenseCompetitionPoPstateHistoryBucketPlatformSubCustomer.csv",
    VAR.Attribute="ProductOrServiceArea",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPsc",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))


state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Location_SP_DefenseCompetitionPricingVehiclePoPstateHistory.csv",
    VAR.Attribute="Pricing.Mechanism.hypothesis.detail",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPrice",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Location_SP_DefenseCompetitionPricingVehiclePoPstateHistory.csv",
    VAR.Attribute="Pricing.Mechanism.Fee",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pFee",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))


state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Location_SP_DefenseCompetitionPricingVehiclePoPstateHistory.csv",
    VAR.Attribute="Vehicle.IDVorAward",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pIDV",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

# debug(statistics.pivot)
state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Location_SP_DefenseCompetitionPricingVehiclePoPstateHistory.csv",
    VAR.Attribute="Vehicle.hypothesis",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pVeh",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))

state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Location_SP_DefenseCompetitionPricingVehiclePoPstateHistory.csv",
    VAR.Attribute="Competition.detail",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pComp",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
))


state.competition.combined<-plyr::join(state.competition.combined,competition.statistics.offers(
    Path,
    "data\\defense_Location_SP_DefenseCompetitionPricingVehiclePoPstateHistory.csv",
    "PoPstateCode",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
)
)


state.competition.combined<-plyr::join(state.competition.combined,
                                        competition.statistics.size(Path
                                                                    ,"data\\Defense_Location_SP_ContractSizeforCompetitionStudy.csv"
                                                                    ,"PoPstateCode",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=TRUE
                                        )
)

summary(state.competition.combined)


state.competition.combined$Exclude<-FALSE
state.competition.combined$Exclude[state.competition.combined$PoPstateCode %in% c("VI",
                                                                         "AS",
                                                                         "MP",
                                                                         "AE",
                                                                         "PW",
                                                                         "US",
                                                                         "UK",
                                                                         "GM",
                                                                         "GB",
                                                                         "JA",
                                                                         "ON",
                                                                         "QC",
                                                                         "   ",
                                                                         "BC")]<-TRUE



StateFit <- lm(pEffComp ~
                   pPSRServices  +
                   pPlatAir +
                   pIDV +
                   pPriceFixed+ 
                   I(pPriceFixed^2)+
                   pPscEngines+
                   pPscPAMS+
                 pPscOther, 
               data=StateList)
summary(StateFit) 
plot(StateFit)


write.table(state.competition.combined
            ,file="data\\defense_state_competition_combined_2000-2013.csv"
            #   ,header=TRUE
            , sep=","
            , row.names=FALSE
            , append=FALSE
)


StateFit <- lm(pEffComp ~
                   pPSRServices  +
                   pPlatAir +
                   pIDV +
                   pPriceFixed+ 
                   I(pPriceFixed^2)+
                   pPscEngines+
                   pPscPAMS+
                 pPscOther, 
               data=StateList)
summary(StateFit) 
plot(StateFit)


# state.competition.combined<-cbind(state.competition.combined,
#                               predict(StateFit,state.competition.combined,interval="prediction",level=0.90)
#                               )
# state.outside.interval<-subset(state.competition.combined,lwr>pEffectiveComp|upr<pEffectiveComp)$PoPstateCode
# 
# 
# 
# state.competition.2014<-competition.statistics(
#     "",
#     "data\\2014DefenseCompetitionByPlatformAreaPoP.csv",
#     "PoPstateCode",
#     2014
# )
# 
# 
# state.competition.2014<-plyr::join(state.competition.2014,competition.statistics.offers(""
#                                                                                         ,"data\\2014DefenseCompetitionVehicleByPlatformAreaPoP.csv"
#                                                                                         ,"PoPstateCode"
#                                                                                         ,2014
# )
# )
# 
# state.competition.2014<-cbind(state.competition.2014,
#                               predict(StateFit,
#                                       state.competition.2014,
#                                       interval="prediction",
#                                       level=0.95)
# )
# subset(state.competition.2014,lwr>pEffectiveComp|upr<pEffectiveComp)$PoPstateCode
# 
# 
# 
# 
# write.table(state.competition.2014
#             ,file="Output\\2014_defense_state_competition_combined.csv"
#             #   ,header=TRUE
#             , sep=","
#             , row.names=FALSE
#             , append=FALSE
# )
# 
# write.table(state.competition.combined
#             ,file="Output\\2000_2013_defense_state_competition_combined.csv"
#             #   ,header=TRUE
#             , sep=","
#             , row.names=FALSE
#             , append=FALSE
# )


``` 



```{r MCCprocessing2014, echo=FALSE}
mcc.competition.combined.2014<-statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerMajorCommand.csv",
    VAR.Attribute="Competition.effective.only",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pCEff",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
)

mcc.competition.combined.2014<-plyr::join(mcc.competition.combined.2014,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerMajorCommand.csv",
    VAR.Attribute="PlatformPortfolio.sum",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPlat",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
))

mcc.competition.combined.2014<-plyr::join(mcc.competition.combined.2014,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerMajorCommand.csv",
    VAR.Attribute="SimpleArea",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Mixed or Unlabeled",
    ColumnPrefix="pPSR",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
))


mcc.competition.combined.2014<-plyr::join(mcc.competition.combined.2014,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionHistoryBucketPlatformSubCustomerMajorCommand.csv",
    VAR.Attribute="ProductOrServiceArea",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPsc",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
))

# debug(statistics.pivot)
mcc.competition.combined.2014<-plyr::join(mcc.competition.combined.2014,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryMajorCommand.csv",
    VAR.Attribute="Pricing.Mechanism.hypothesis.detail",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPrice",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
))

mcc.competition.combined.2014<-plyr::join(mcc.competition.combined.2014,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryMajorCommand.csv",
    VAR.Attribute="Pricing.Mechanism.Fee",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pFee",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
))


mcc.competition.combined.2014<-plyr::join(mcc.competition.combined.2014,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryMajorCommand.csv",
    VAR.Attribute="Vehicle.IDVorAward",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pIDV",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
))
# debug(statistics.pivot)
mcc.competition.combined.2014<-plyr::join(mcc.competition.combined.2014,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryMajorCommand.csv",
    VAR.Attribute="Vehicle.hypothesis",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pVeh",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
))

mcc.competition.combined.2014<-plyr::join(mcc.competition.combined.2014,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryMajorCommand.csv",
    VAR.Attribute="Competition.detail",
    VAR.UnitOfAnalysis="MajorCommandID",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pComp",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
))


mcc.competition.combined.2014<-plyr::join(mcc.competition.combined.2014,competition.statistics.offers(
    Path,
    "data\\defense_Office_SP_DefenseCompetitionPricingVehicleHistoryMajorCommand.csv",
    "MajorCommandID",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
)
)


mcc.competition.combined.2014<-plyr::join(mcc.competition.combined.2014,
                                        competition.statistics.size(Path
                                                                    ,"data\\Defense_Contract_SP_ContractSizeforCompetitionStudyMajorCommand.csv"
                                                                    ,"MajorCommandID",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
                                        )
)

summary(mcc.competition.combined.2014)


mcc.competition.combined.2014$TotalThreshold<- cut2(mcc.competition.combined.2014$TotalValue,cuts=c(1000000,10000000,100000000))
mcc.competition.combined.2014$AnnualThreshold<- cut2(mcc.competition.combined.2014$MaxAnnualValue,cuts=c(1000000,10000000,100000000))
mcc.competition.combined.2014$Exclude[mcc.competition.combined.2014$MajorCommandID %in% c("ORG-2841",
                                                                                "ORG-2776",
                                                                                "ORG-4793",
                                                                                "ORG-2849",
                                                                                "ORG-2762",
                                                                                "ORG-4020",
                                                                                "ORG-2840",
                                                                                "ORG-2757"
)]<-TRUE




summary(mcc.competition.combined.2014$Threshold)
summary(mcc.competition.combined.2014[mcc.competition.combined.2014$MajorCommandID %in% c("ORG-2841",
                                                                                "ORG-2776",
                                                                                "ORG-4793",
                                                                                "ORG-2849",
                                                                                "ORG-2762",
                                                                                "ORG-4020",
                                                                                "ORG-2840",
                                                                                "ORG-2757"),c("TotalValue","MaxAnnualValue")]
)
summary(mcc.competition.combined.2014[!mcc.competition.combined.2014$MajorCommandID %in% c("ORG-2841",
                                                                                 "ORG-2776",
                                                                                 "ORG-4793",
                                                                                 "ORG-2849",
                                                                                 "ORG-2762",
                                                                                 "ORG-4020",
                                                                                 "ORG-2840",
                                                                                 "ORG-2757"),c("TotalValue","MaxAnnualValue")]
)
# 
# ggplot(data=mcc.competition.combined.2014,
#        aes(x=MaxAnnualValue,fill=Threshold))+geom_bar()+scale_x_log10(labels = comma)+#bin=0.01))+
#     facet_wrap(~Exclude,ncol=1)
# 
# 
# ggplot(data=mcc.competition.combined.2014,
#        aes(x=TotalValue,fill=Threshold))+geom_bar()+scale_x_log10(labels = comma)+#bin=0.01))+
#     facet_wrap(~Exclude,ncol=1)



write.table(mcc.competition.combined.2014
            ,file="data\\defense_mcc_competition_combined_2014.csv"
            #   ,header=TRUE
            , sep=","
            , row.names=FALSE
            , append=FALSE
)

mcc.competition.combined.2014<-read.tables("data\\defense_mcc_competition_combined_2014.csv",
            header=TRUE, sep=",", na.strings="NA", dec=".", strip.white=TRUE, 
            stringsAsFactors=TRUE
        )

MCCshortList<-subset(mcc.competition.combined.2014,Exclude==FALSE
)

MCCfit<-lm(pEffComp ~ pPSRServices+ I(pPSRServices^2)+ pPlatWnA+ pIDV+ pPlatAir+ pVehSAC, data = MCCshortList)

mcc.competition.combined.2014<-cbind(mcc.competition.combined.2014,
                              predict(MCCfit,
                                      mcc.competition.combined.2014,
                                      interval="prediction",
                                      level=0.90)
)
names(mcc.competition.combined.2014)[names(mcc.competition.combined.2014)=="lwr"]<-"PredLwr90"
names(mcc.competition.combined.2014)[names(mcc.competition.combined.2014)=="upr"]<-"PredUpr90"
names(mcc.competition.combined.2014)[names(mcc.competition.combined.2014)=="fit"]<-"PredFit90"







mcc.competition.combined.2014<-cbind(mcc.competition.combined.2014,
                              predict(MCCfit,
                                      mcc.competition.combined.2014,
                                      interval="prediction",
                                      level=0.95)
)
names(mcc.competition.combined.2014)[names(mcc.competition.combined.2014)=="lwr"]<-"PredLwr95"
names(mcc.competition.combined.2014)[names(mcc.competition.combined.2014)=="upr"]<-"PredUpr95"
names(mcc.competition.combined.2014)[names(mcc.competition.combined.2014)=="fit"]<-"PredFit95"
View(mcc.competition.combined.2014)

write.table(mcc.competition.combined.2014
            ,file="data\\defense_mcc_competition_combined_2014.csv"
            #   ,header=TRUE
            , sep=","
            , row.names=FALSE
            , append=FALSE
)


``` 




```{r StateProcessing2014, echo=FALSE}

state.competition.combined<-statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_location_SP_DefenseCompetitionPoPstateHistoryBucketPlatformSubCustomer.csv",
    VAR.Attribute="Competition.effective.only",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pCEff",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
)

state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_location_SP_DefenseCompetitionPoPstateHistoryBucketPlatformSubCustomer.csv",
    VAR.Attribute="PlatformPortfolio.sum",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPlat",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
))

state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_location_SP_DefenseCompetitionPoPstateHistoryBucketPlatformSubCustomer.csv",
    VAR.Attribute="SimpleArea",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Mixed or Unlabeled",
    ColumnPrefix="pPSR",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
))
# 

state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_location_SP_DefenseCompetitionPoPstateHistoryBucketPlatformSubCustomer.csv",
    VAR.Attribute="ProductOrServiceArea",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPsc",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
))


state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Location_SP_DefenseCompetitionPricingVehiclePoPstateHistory.csv",
    VAR.Attribute="Pricing.Mechanism.hypothesis.detail",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pPrice",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
))

state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Location_SP_DefenseCompetitionPricingVehiclePoPstateHistory.csv",
    VAR.Attribute="Pricing.Mechanism.Fee",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pFee",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
))


state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Location_SP_DefenseCompetitionPricingVehiclePoPstateHistory.csv",
    VAR.Attribute="Vehicle.IDVorAward",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pIDV",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
))

# debug(statistics.pivot)
state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Location_SP_DefenseCompetitionPricingVehiclePoPstateHistory.csv",
    VAR.Attribute="Vehicle.hypothesis",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pVeh",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
))

state.competition.combined<-plyr::join(state.competition.combined,statistics.pivot(
    VAR.Path=Path,
    competition.file.name="data\\defense_Location_SP_DefenseCompetitionPricingVehiclePoPstateHistory.csv",
    VAR.Attribute="Competition.detail",
    VAR.UnitOfAnalysis="PoPstateCode",
    UnlabeledValue="Unlabeled",
    ColumnPrefix="pComp",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
))


state.competition.combined<-plyr::join(state.competition.combined,competition.statistics.offers(
    Path,
    "data\\defense_Location_SP_DefenseCompetitionPricingVehiclePoPstateHistory.csv",
    "PoPstateCode",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
)
)


state.competition.combined<-plyr::join(state.competition.combined,
                                        competition.statistics.size(Path
                                                                    ,"data\\Defense_Location_SP_ContractSizeforCompetitionStudy.csv"
                                                                    ,"PoPstateCode",
        LimitFiscalYear=2014,
    ExcludeFiscalYear=FALSE
                                        )
)

summary(state.competition.combined)


state.competition.combined$Exclude<-FALSE
state.competition.combined$Exclude[state.competition.combined$PoPstateCode %in% c("VI",
                                                                         "AS",
                                                                         "MP",
                                                                         "AE",
                                                                         "PW",
                                                                         "US",
                                                                         "UK",
                                                                         "GM",
                                                                         "GB",
                                                                         "JA",
                                                                         "ON",
                                                                         "QC",
                                                                         "   ",
                                                                         "BC")]<-TRUE



StateFit <- lm(pEffComp ~
                   pPSRServices  +
                   pPlatAir +
                   pIDV +
                   pPriceFixed+ 
                   I(pPriceFixed^2)+
                   pPscEngines+
                   pPscPAMS+
                 pPscOther, 
               data=StateList)
summary(StateFit) 
plot(StateFit)


write.table(state.competition.combined
            ,file="data\\defense_state_competition_combined_2014.csv"
            #   ,header=TRUE
            , sep=","
            , row.names=FALSE
            , append=FALSE
)


StateFit <- lm(pEffComp ~ 
       pPSRServices+ 
       pPlatAir+ 
       pIDV+ 
       pPriceFixed+ 
       I(pPriceFixed^2)+
       pPscEngines+ 
       pPscPAMS+ 
       pPscOther, 
   data = StateList)
summary(StateFit) 
plot(StateFit)

state.competition.combined<-read.tables("data\\defense_state_competition_combined_2014.csv",
            header=TRUE, sep=",", na.strings="NA", dec=".", strip.white=TRUE, 
            stringsAsFactors=TRUE
        )


state.competition.combined.2014<-cbind(state.competition.combined.2014,
                              predict(StateFit,
                                      state.competition.combined.2014,
                                      interval="prediction",
                                      level=0.90)
)
names(state.competition.combined.2014)[names(state.competition.combined.2014)=="lwr"]<-"PredLwr90"
names(state.competition.combined.2014)[names(state.competition.combined.2014)=="upr"]<-"PredUpr90"
names(state.competition.combined.2014)[names(state.competition.combined.2014)=="fit"]<-"PredFit90"


state.competition.combined.2014<-cbind(state.competition.combined.2014,
                              predict(StateFit,
                                      state.competition.combined.2014,
                                      interval="prediction",
                                      level=0.95)
)
names(state.competition.combined.2014)[names(state.competition.combined.2014)=="lwr"]<-"PredLwr95"
names(state.competition.combined.2014)[names(state.competition.combined.2014)=="upr"]<-"PredUpr95"
names(state.competition.combined.2014)[names(state.competition.combined.2014)=="fit"]<-"PredFit95"
View(state.competition.combined.2014)

write.table(state.competition.combined
            ,file="data\\defense_state_competition_combined_2014.csv"
            #   ,header=TRUE
            , sep=","
            , row.names=FALSE
            , append=FALSE
)


``` 



Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
